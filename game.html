<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>PyGrimoire Game</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        canvas {
            display: block;
            margin: auto;
        }
    </style>
</head>

<body>
    <script>
        class MainScene extends Phaser.Scene {
            constructor() {
                super('MainScene');
            }

            preload() {
                this.load.image('player', 'https://labs.phaser.io/assets/sprites/phaser-dude.png');
                this.load.image('enemy', 'https://labs.phaser.io/assets/sprites/space-baddie.png');
                this.load.image('bullet', 'https://labs.phaser.io/assets/sprites/bullet.png');
                this.load.image('background', 'https://labs.phaser.io/assets/tilemaps/tiles/grass.png');
            }

            create() {
                const mapSize = 2000;
                this.cameras.main.setBounds(0, 0, mapSize, mapSize);
                this.physics.world.setBounds(0, 0, mapSize, mapSize);

                this.background = this.add.tileSprite(0, 0, mapSize, mapSize, 'background').setOrigin(0);

                this.player = this.physics.add.sprite(400, 300, 'player');
                this.player.setCollideWorldBounds(true);
                this.player.health = 100;

                this.cameras.main.startFollow(this.player);

                this.cursors = this.input.keyboard.createCursorKeys();
                this.WASD = this.input.keyboard.addKeys('W,A,S,D');
                this.spaceBar = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);

                this.bullets = this.physics.add.group();
                this.lastFired = 0;

                this.enemies = this.physics.add.group();
                this.spawnEnemy();

                this.physics.add.overlap(this.bullets, this.enemies, (bullet, enemy) => {
                    bullet.destroy();
                    enemy.health -= 50;
                    if (enemy.health <= 0) enemy.destroy();
                });

                this.physics.add.overlap(this.player, this.enemies, (player, enemy) => {
                    player.health -= 1;
                    if (player.health <= 0) {
                        this.scene.restart();
                    }
                });

                // Health bars
                this.playerHealthBar = this.add.graphics();
                this.playerHealthBar.setScrollFactor(0);
            }

            update(time) {
                const speed = 200;
                this.player.setVelocity(0);

                if (this.WASD.A.isDown) this.player.setVelocityX(-speed);
                if (this.WASD.D.isDown) this.player.setVelocityX(speed);
                if (this.WASD.W.isDown) this.player.setVelocityY(-speed);
                if (this.WASD.S.isDown) this.player.setVelocityY(speed);

                if (this.spaceBar.isDown && time > this.lastFired) {
                    this.shootBullet();
                    this.lastFired = time + 300;
                }

                this.enemies.getChildren().forEach(enemy => {
                    this.physics.moveToObject(enemy, this.player, 100);
                });

                this.drawPlayerHealthBar();
            }

            shootBullet() {
                const bulletSpeed = 400;
                const bullet = this.bullets.create(this.player.x, this.player.y, 'bullet');
                bullet.setCollideWorldBounds(true);
                bullet.body.onWorldBounds = true;
                bullet.body.world.on('worldbounds', function (body) {
                    if (body.gameObject === bullet) {
                        bullet.destroy();
                    }
                });

                const direction = new Phaser.Math.Vector2(0, 0);
                if (this.cursors.left.isDown) direction.x = -1;
                else if (this.cursors.right.isDown) direction.x = 1;
                if (this.cursors.up.isDown) direction.y = -1;
                else if (this.cursors.down.isDown) direction.y = 1;

                if (direction.length() === 0) {
                    direction.y = -1; // Default direction
                }

                direction.normalize();
                bullet.setVelocity(direction.x * bulletSpeed, direction.y * bulletSpeed);
            }

            spawnEnemy() {
                const x = Phaser.Math.Between(0, 2000);
                const y = Phaser.Math.Between(0, 2000);
                const enemy = this.enemies.create(x, y, 'enemy');
                enemy.setCollideWorldBounds(true);
                enemy.health = 100;
            }

            drawPlayerHealthBar() {
                this.playerHealthBar.clear();
                this.playerHealthBar.fillStyle(0x000000);
                this.playerHealthBar.fillRect(10, 10, 104, 14);
                this.playerHealthBar.fillStyle(0xff0000);
                this.playerHealthBar.fillRect(12, 12, this.player.health, 10);
            }
        }

        const config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            physics: {
                default: 'arcade',
                arcade: {
                    debug: false,
                }
            },
            scene: MainScene
        };

        const game = new Phaser.Game(config);
    </script>
</body>

</html>